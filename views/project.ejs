<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" ng-app="myApp"  ng-controller="ProjectCtrl"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>{{project.name}}</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <link rel="stylesheet" href="../css/bootstrap.min.css">        
        <link rel="stylesheet" href="/css/bootstrap-responsive.min.css">
        <link rel="stylesheet" href="/css/main.css">
        <link rel="stylesheet" href="/css/codemirror.css">
        <link rel="stylesheet" href="/css/bootstrap-notify.css">
        <style>
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
        </style>

        <script src="/js/vendor/modernizr-2.6.1-respond-1.1.0.min.js"></script>        
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->

        <!-- ### PAGE HEADER ### -->
        <div class="navbar navbar-inverse navbar-fixed-top">
          <div class="navbar-inner">
            <div class="container-fluid">
              <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </a>
              <a class="brand" href="/">CC-Edit</a>
              <div class="nav-collapse collapse">
                <ul class="nav">
                  <li class="active"><a href="#">Home</a></li>
                  <li><a href="#download">Download as Zip</a></li>
                  <li><a href="#addCollabModal" data-toggle="modal">Add Collaborators</a></li>
                  <li>
                    <form class="navbar-search pull-left">
                      <input type="text" class="search-query" placeholder="Search Project Files">
                    </form>
                  </li>
                </ul>            
                <ul class="nav pull-right">
                  <li class="dropdown ">
                    <a href="#" class="navbar-link dropdown-toggle" data-toggle="dropdown">{{username}} <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                      <li><a href="#">Account Info</a></li>
                      <li class="divider"></li>
                      <li><a href="/logout">Logoff</a></li>
                    </ul>
                  </li>
                </ul>
              </div><!--/.nav-collapse -->
            </div>
          </div>
        </div><!-- /PAGE HEADER -->
      
        <!-- ### PAGE BODY ### -->
        <div id="wrap" class="container-fluid">      
          
          <div class="row-fluid">

            <!-- ### FILE LIST ### -->
            <div class="span2">
              <div class="well sidebar-nav">
                <ul id="project-files" class="nav nav-list">
                  <li class="nav-header">Files <button class="close" type="button" ng-click="showAddFile()" rel="tooltip" title="Add a new file">+</button></li>
                  <!--<li class="active"><a href="#">Sample file</a></li>-->                  
                  <li ng-repeat="file in project.files">
                    <a ng-click="openFile(file.fileId)" href="#">{{file.fileName}}</a>                     
                      <button class="close" ng-click="deleteFile(file.fileId, file.fileName)" rel="tooltip" title="Delete file"><i class="icon-trash"></i></button>
                      <!--<button class="close" ng-click=""><i class="icon-edit"></i></button>  -->                                      
                  </li>
                  <li ng-show="showAddNewFileTextbox">
                    <form id="new-file" ng-submit="addFile()">
                      <input id="new-file" placeholder="Specify the filename" ng-model="newFileName" focus-on="showAddNewFileTextbox" required>                      
                    </form>
                    <button class="close" ng-click="showAddNewFileTextbox=false"><i class="icon-remove"></i></button>
                  </li>
                  
                </ul>
              </div><!--/.well -->
            </div><!--/span-->

            <!-- ### CODE AREA ### -->
            <div class="span8" ng-controller="FileCtrl">
              <div class="tabbable"> <!-- Only required for left/right tabs -->
                <ul class="nav nav-tabs">
                  <li ng-repeat="file in openFiles" ng-class="{active: file._id == activeFile._id }"><!--class="active"-->
                    <!-- moved the change tab code from bootstrp to angular js, due to need for getting currently active tab -->
                    <a data-toggle="tab" ng-click="changeActiveFile(file._id)">{{file.name}}<button class="close" ng-click="closeFile(file._id)">×</button></a> <!--href="#{{file._id}}" -->
                  </li>
                </ul>
                <div><!-- class="tab-content">  same tab, just contents change-->                  
                  <div class="tab-pane" class="active">                  
                    <div id="code-content" class="hero-unit">
                      <textarea ui-codemirror="{lineNumbers: 'true', mode:'htmlmixed'}" ng-model="activeFile.contents" ng-modal-instant ng-change="sendUpdatedFile()"></textarea>                      
                    </div>
                    <div class="row-fluid">            
                    </div><!--/row-->
                  </div>
                </div>
              </div>
            </div><!--/CODE AREA-->

            <!-- ### CHAT AREA ### -->
            <div class="span2" ng-controller="ChatCtrl">
              
              <!-- ### ONLINE USERS ### -->              
              <div class="well sidebar-nav">
                <ul id="online-users" class="nav nav-list">
                  <li class="nav-header">Online Users</li>
                  <li ng-repeat="user in onlineUsers">{{user}}</li>
                </ul>
              </div><!--/ONLINE USERS-->

              <!-- ### CHAT BAR ### -->              
              <div class="well sidebar-nav">
                <ul class="nav nav-list">
                  <li class="nav-header">Chat</li>
                  <li id="messages" ng-repeat="log in chatLog">
                    <b>{{log.username}}:</b> {{log.data}}
                  </li>
                </ul>
                <textarea id="chat-text" rows="4" ng-model='chatText' ui-keypress="{13:'sendChat()'}"></textarea>
                <!-- <input type="button" value="Send" id="send-button" ng-click='sendChat()'> -->              
              </div><!-- /CHAT BAR -->

            </div><!--/CHAT AREA--> 

          </div><!--/row--> 
          <div class='notifications bottom-left'></div> <!-- bootstrap-notify -->
          
          <!-- ### ADD COLLOBORATOR DIALOG ### --> 
          <div id="addCollabModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
              <h3 id="myModalLabel">Add Collaborators</h3>
            </div>
            <div class="modal-body">
              <form id="find-user" ng-submit="findUser()">
                <input placeholder="Enter the username" ng-model="findUserString">
                <button class="btn" type="submit">Search</button>
              </form>  
                <table class="table table-hover">
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                  </tr>
                  <tr ng-repeat="user in searchedUsers" ng-click="addToSelectedUsers(user)" ng-show="isUserSelected(user)">
                    <td>{{user.displayName}}</td>
                    <td>{{user.email}}</td>
                  </tr>
                </table>
                <hr>
                Selected Users: <span class="pager" ng-repeat="user in selectedUsers">
                  <a href="#" ng-click="removeFromSelectedUsers(user)" rel="tooltip" title="Remove user">{{user.displayName}}</a>
                </span>
              
            </div>
            <div class="modal-footer">
              <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
              <button class="btn btn-primary" ng-class="{disabled: selectedUsers.length<1}" ng-click="addSelectedUsersToProject()">Add Selected Users</button>
            </div>
          </div> <!-- /ADD COLLOBORATOR DIALOG --> 

          </div> <!-- /PAGE BODY -->


          <hr>
          <footer>
              <div class="container">
                <p class="muted credit">Created by <a href="http://www.nithinag.com">Nithin Anand Gangadharan</a>.</p>
              </div>
          </footer>      

        

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="../js/vendor/jquery-1.8.0.min.js"><\/script>')</script>

        <script src="/socket.io/socket.io.js"></script>
        <script src="/js/vendor/bootstrap.min.js"></script>
        <script src="/js/vendor/bootbox.min.js"></script>
        <script src="/js/vendor/bootstrap-notify.js"></script>
        <script src="/js/vendor/diff_match_patch.js"></script>

        <script src="/js/vendor/codemirror-compressed.js"></script>
        
        <!--http://ajax.googleapis.com/ajax/libs/angularjs/1.0.3/angular.min.js -->
        <script src="/js/vendor/angular.min.js"></script>
        <script src="/js/app.js"></script>
        <script src="/js/services.js"></script>
        <script src="/js/controllers.js"></script>
        <script src="/js/filters.js"></script>
        <script src="/js/directives.js"></script>

        <script src="/js/plugins.js"></script>
        <script src="/js/main.js"></script>

        <!--<script src="../nowjs/now.js"></script> -->

        <script>
          $(document).ready(function(){
          });
        </script>

        <!-- Google Analytics Code -->
        <script>
            /*var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));*/
        </script>

        <script>
          var username = "<%= username %>";
          var projectId = "<%= projectId %>";

          /**************************
          * MISC FUNCTIONS
          **************************/
          var dmp = new diff_match_patch();
          var patch_text = '';

          function diff_launch(text1, text2) {

            var diff = dmp.diff_main(text1, text2, true);
            if (diff.length > 2) {
              dmp.diff_cleanupSemantic(diff);
            }
            var patch_list = dmp.patch_make(text1, text2, diff);
            //patch_text = dmp.patch_toText(patch_list);

            return patch_list;
          }


          function patch_launch(text1, patch_list) {
            //var patches = dmp.patch_fromText(patch_text);
            //var results = dmp.patch_apply(patches, text1);
            
            var results = dmp.patch_apply(patch_list, text1);
            return  results[0];
            
            /*results = results[1];
            var html = '';
            for (var x = 0; x < results.length; x++) {
              if (results[x]) {
                html += 'Ok';
              } else {
                html += 'Fail';
              }
            }
            console.log("Status:" + html);*/
          }
        </script>

    </body>
</html>
